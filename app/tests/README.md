# Unit Tests для системы рекомендаций фильмов

Этот каталог содержит unit-тесты для проверки работоспособности ключевых элементов системы.

## Структура тестов

- `conftest.py` - Конфигурация pytest и фикстуры
- `test_user_operations.py` - Тесты операций с пользователями
- `test_wallet_operations.py` - Тесты операций с кошельком
- `test_movie_recommendations.py` - Тесты рекомендаций фильмов
- `test_integration_scenarios.py` - Интеграционные тесты

## Что тестируется

### 1. Операции с пользователями
- ✅ Регистрация новых пользователей
- ✅ Вход в систему
- ✅ Валидация email и паролей
- ✅ Проверка уникальности email
- ✅ Создание пользователей с правами администратора

### 2. Операции с кошельком
- ✅ Пополнение баланса
- ✅ Списание денег с баланса
- ✅ Проверка прав доступа
- ✅ Создание записей транзакций
- ✅ Обновление баланса после операций

### 3. Рекомендации фильмов
- ✅ Получение рекомендаций по запросу
- ✅ Проверка достаточности баланса
- ✅ Различные тарифы для пользователей и админов
- ✅ Создание записей предсказаний
- ✅ Связь с системой транзакций

### 4. История и отчеты
- ✅ История транзакций пользователя
- ✅ История рекомендаций пользователя
- ✅ Изоляция данных между пользователями

### 5. Интеграционные сценарии
- ✅ Полный пользовательский сценарий
- ✅ Множественные транзакции
- ✅ Обработка ошибок
- ✅ Консистентность данных

## Установка зависимостей

```bash
cd app
pip install -r tests/requirements.txt
```

## Запуск тестов

### Способ 1: Через скрипт (рекомендуется)
```bash
cd app
python run_tests.py
```

### Способ 2: Напрямую через pytest
```bash
cd app
pytest
```

### Запуск конкретной группы тестов
```bash
# Только unit тесты
pytest -m unit

# Только интеграционные тесты
pytest -m integration

# Тесты конкретного модуля
pytest tests/test_user_operations.py

# Тесты конкретного класса
pytest tests/test_user_operations.py::TestUserOperations

# Конкретный тест
pytest tests/test_user_operations.py::TestUserOperations::test_user_signup_success
```

### Запуск с подробным выводом
```bash
pytest -v -s
```

### Запуск с покрытием кода
```bash
pytest --cov=app --cov-report=html
```

## Особенности реализации

### База данных для тестов
- Используется SQLite in-memory для быстрого выполнения тестов
- Каждый тест получает чистую базу данных
- Векторы эмулируются через моки (SQLite не поддерживает pgvector)

### Моки и заглушки
- ML сервис полностью замокан для изоляции тестов
- Аутентификация эмулируется через патчи
- Векторы фильмов заменены на заглушки

### Фикстуры
- `mock_user` - тестовый пользователь с кошельком
- `mock_admin_user` - тестовый администратор
- `mock_movie` - тестовый фильм
- `mock_transaction` - тестовая транзакция
- `mock_prediction` - тестовое предсказание

## API Endpoints для тестирования

### Пользователи
- `POST /api/users/signup` - Регистрация
- `POST /api/users/signin` - Вход
- `GET /api/users/balance` - Получение баланса
- `POST /api/users/balance/adjust` - Изменение баланса
- `GET /api/users/transaction/history` - История транзакций

### Рекомендации
- `POST /api/events/prediction/new` - Новые рекомендации
- `GET /api/events/prediction/history` - История рекомендаций

## Добавление новых тестов

1. Создайте новый файл `test_*.py`
2. Наследуйтесь от базового класса или создайте новый
3. Используйте существующие фикстуры или создайте новые
4. Добавьте маркеры для категоризации тестов

## Пример нового теста

```python
import pytest

class TestNewFeature:
    def test_new_feature_works(self, client, db_session, mock_user):
        """Тест новой функциональности"""
        with patch('app.auth.basic.get_current_user', return_value=mock_user):
            response = client.get("/api/new/endpoint")
            assert response.status_code == 200
```

## Troubleshooting

### Ошибка импорта модулей
Убедитесь, что вы находитесь в корневой директории проекта и PYTHONPATH настроен правильно.

### Ошибки с базой данных
Проверьте, что все модели импортированы в `conftest.py` и SQLModel настроен корректно.

### Проблемы с аутентификацией
Используйте патчи для `get_current_user` в тестах, требующих аутентификации.

### Ошибки с путями API
Убедитесь, что используете правильные пути:
- Пользователи: `/api/users/*`
- Рекомендации: `/api/events/*`

## Статистика тестов

- **Всего тестов**: 25+
- **Unit тесты**: 15+
- **Интеграционные тесты**: 10+
- **Покрытие**: Основные функции системы
- **Время выполнения**: ~30 секунд
