<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'/>
    <meta name='viewport' content='width=device-width,initial-scale=1'/>
    <title>Transaction History</title>
    <link rel="stylesheet" href="/static/css/main.css">
</head>
<body>
    <div class='container'>
        <div class='topbar'>
            <a class='link' href='/web'>‚Üê Back</a>
            <strong>Transaction History</strong>
            <span></span>
        </div>
        
        <div id='protected' class='card hidden'>
            <div class='row' style='justify-content:space-between;'>
                <span id='status' class='muted'></span>
            </div>
            <div style='height:6px'></div>
            <div id='hist' class='scroll'></div>
        </div>
    </div>
    
    <script src="/static/js/main.js"></script>
    <script>
        function isAuthed() {
            try {
                return !!(localStorage.getItem('email') && localStorage.getItem('password'));
            } catch (_) {
                return false;
            }
        }
        
        function renderTransactions(items) {
            if (!Array.isArray(items) || items.length === 0) {
                return '<div class="muted">No transaction history yet</div>';
            }
            
            return items.map(it => `
                <div class="movie">
                    <div><strong>${new Date(it.timestamp).toLocaleString()}</strong></div>
                    <div class="muted">Type: ${it.type}</div>
                    <div class="muted">Amount: ${it.amount > 0 ? '+' : ''}${it.amount}</div>
                </div>
            `).join('');
        }
        
        async function loadHistory() {
            setText('status', '');
            const r = await fetch('/api/users/transaction/history', {headers: authHeader()});
            if (!r.ok) return setText('status', 'Failed to load transaction history');
            const data = await r.json();
            setHTML('hist', renderTransactions(data));
        }
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            if (!isAuthed()) {
                window.location.href = '/web';
                return;
            }
            document.getElementById('protected').classList.remove('hidden');
            loadHistory();
        });
    </script>
</body>
</html>
